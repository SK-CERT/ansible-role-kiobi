---

- name: get saved objects from kibana
  uri:
    method: GET
    url: "{{ source['host'] }}:{{ source['port'] }}/api/saved_objects/_find?{{ source['parameters'] }}"
    return_content: true
    headers:
      kbn-xsrf: true
      Content-Type: 'application/json'
    use_proxy: "{{ source['port'] in [80, 443] }}"
  register: objects
  changed_when: objects.status == 200
  tags: get

- name: normalize saved objects
  set_fact:
    saved_objects: "{{ lookup('template', 'saved_objects.j2') }}"
  tags: get

- name: save return objects to file
  when:
    - save_contents | bool
  delegate_to: localhost
  copy:
    content: "{{ saved_objects }}"
    dest: "{{ file }}"
  tags: get

- name: post saved objects to kibana
  when:
    - explicit_body is defined or saved_objects | length | bool
  uri:
    method: POST
    url: "{{ destination['host'] }}:{{ destination['port'] }}/api/saved_objects/_bulk_create?{{ destination['parameters'] }}"
    body: "{{ (explicit_body | default([]) + saved_objects | default([])) | to_json }}"
    body_format: 'json'
    headers:
      kbn-xsrf: true
      Content-Type: 'application/json'
    use_proxy: "{{ destination['port'] in [80, 443] }}"
  tags: post
